name: Release

on:
  push:
    branches: [main]

jobs:
  release:
    runs-on: macos-14
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if this is a PR merge
        id: check_merge
        run: |
          PARENT_COUNT=$(git rev-list --parents -n 1 HEAD | wc -w)
          PARENT_COUNT=$((PARENT_COUNT - 1))
          echo "parent_count=$PARENT_COUNT" >> $GITHUB_OUTPUT
          if [ "$PARENT_COUNT" -gt 1 ]; then
            echo "is_merge=true" >> $GITHUB_OUTPUT
          else
            echo "is_merge=false" >> $GITHUB_OUTPUT
          fi

      - name: Get latest release version
        if: steps.check_merge.outputs.is_merge == 'true'
        id: version
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Fetching latest release..."
          LATEST_TAG=$(gh release list --limit 1 --json tagName --jq '.[0].tagName' 2>/dev/null || echo "")
          echo "Latest tag: $LATEST_TAG"

          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" = "null" ]; then
            echo "No previous releases found, starting with v0.1.0"
            NEW_VERSION="v0.1.0"
          else
            VERSION=${LATEST_TAG#v}
            MAJOR=$(echo "$VERSION" | cut -d. -f1)
            MINOR=$(echo "$VERSION" | cut -d. -f2)
            PATCH=$(echo "$VERSION" | cut -d. -f3)

            # Increment minor version, reset patch
            NEW_MINOR=$((MINOR + 1))
            NEW_VERSION="v${MAJOR}.${NEW_MINOR}.0"

            echo "Previous version: $LATEST_TAG"
          fi

          echo "New version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Setup Xcode
        if: steps.check_merge.outputs.is_merge == 'true'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build release
        if: steps.check_merge.outputs.is_merge == 'true'
        run: |
          echo "Building release..."
          swift build -c release
          echo "Build complete"

      - name: Create app bundle
        if: steps.check_merge.outputs.is_merge == 'true'
        run: |
          APP_NAME="Connor"
          APP_BUNDLE="${APP_NAME}.app"
          VERSION="${{ steps.version.outputs.new_version }}"
          VERSION_NUMBER="${VERSION#v}"

          echo "Creating app bundle for ${APP_NAME} version ${VERSION_NUMBER}..."

          # Create app bundle structure
          mkdir -p "${APP_BUNDLE}/Contents/MacOS"
          mkdir -p "${APP_BUNDLE}/Contents/Resources"

          # Copy executable
          cp ".build/release/${APP_NAME}" "${APP_BUNDLE}/Contents/MacOS/"

          # Copy Info.plist from source and update version numbers
          cp "Sources/Connor/Resources/Info.plist" "${APP_BUNDLE}/Contents/"
          plutil -replace CFBundleShortVersionString -string "${VERSION_NUMBER}" "${APP_BUNDLE}/Contents/Info.plist"
          plutil -replace CFBundleVersion -string "${VERSION_NUMBER}" "${APP_BUNDLE}/Contents/Info.plist"

          # Create PkgInfo
          echo -n "APPL????" > "${APP_BUNDLE}/Contents/PkgInfo"

          # Compile Assets.xcassets (app icon)
          ASSETS_DIR="Sources/Connor/Resources/Assets.xcassets"
          if [ -d "$ASSETS_DIR" ]; then
            xcrun actool "$ASSETS_DIR" \
              --compile "${APP_BUNDLE}/Contents/Resources" \
              --platform macosx \
              --minimum-deployment-target 14.0 \
              --app-icon AppIcon \
              --output-partial-info-plist /tmp/connor-assets-info.plist
          fi

          echo "App bundle created"

      - name: Code sign app bundle
        if: steps.check_merge.outputs.is_merge == 'true'
        run: |
          echo "Code signing app bundle (ad-hoc)..."
          codesign --force --deep --sign - "Connor.app"
          echo "Verifying code signature..."
          codesign --verify --verbose "Connor.app"
          echo "Code signing complete"

      - name: Create DMG
        if: steps.check_merge.outputs.is_merge == 'true'
        id: dmg
        run: |
          DMG_NAME="Connor-${{ steps.version.outputs.new_version }}.dmg"
          echo "Creating DMG: ${DMG_NAME}..."

          # Create temporary directory for DMG contents
          mkdir -p dmg_contents
          cp -R Connor.app dmg_contents/

          # Create symbolic link to Applications folder
          ln -s /Applications dmg_contents/Applications

          # Create DMG
          hdiutil create -volname "Connor" -srcfolder dmg_contents -ov -format UDZO "${DMG_NAME}"

          echo "DMG created: ${DMG_NAME}"
          echo "dmg_path=${DMG_NAME}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        if: steps.check_merge.outputs.is_merge == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version.outputs.new_version }}"
          DMG_PATH="${{ steps.dmg.outputs.dmg_path }}"

          # Get commit message for release notes
          COMMIT_MSG=$(git log -1 --pretty=%B)

          cat > release_notes.md << EOF
          ## What's New

          ${COMMIT_MSG}

          ## Installation

          1. Download \`${DMG_PATH}\` below
          2. Open the DMG file
          3. Drag Connor.app to your Applications folder
          4. On first launch, you may need to right-click and select "Open" to bypass Gatekeeper

          > **Note**: This release is ad-hoc signed and not notarized with Apple.
          > On first launch, right-click the app and select "Open" to bypass the security warning.
          EOF

          gh release create "${VERSION}" \
            "${DMG_PATH}" \
            --title "Connor ${VERSION}" \
            --notes-file release_notes.md

          echo "Release ${VERSION} created"

      - name: Update Homebrew cask
        if: steps.check_merge.outputs.is_merge == 'true'
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.new_version }}"
          VERSION_NUMBER="${VERSION#v}"
          DMG_PATH="${{ steps.dmg.outputs.dmg_path }}"
          SHA256=$(shasum -a 256 "${DMG_PATH}" | cut -d ' ' -f 1)

          echo "Updating Homebrew cask to version ${VERSION_NUMBER} with SHA256 ${SHA256}"

          git clone https://x-access-token:${GH_TOKEN}@github.com/mkmik/homebrew-connor.git
          cd homebrew-connor

          cat > Casks/connor.rb << EOF
          cask "connor" do
            version "${VERSION_NUMBER}"
            sha256 "${SHA256}"

            url "https://github.com/mkmik/connor/releases/download/v#{version}/Connor-v#{version}.dmg"
            name "Connor"
            desc "Developer tools macOS application"
            homepage "https://github.com/mkmik/connor"

            depends_on macos: ">= :sonoma"

            app "Connor.app"

            zap trash: [
              "~/Library/Preferences/com.connor.app.plist",
              "~/Library/Application Support/Connor",
              "~/Library/Caches/Connor",
            ]
          end
          EOF

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/connor.rb
          git commit -m "Update connor to ${VERSION_NUMBER}"
          git push

          echo "Homebrew cask updated"
